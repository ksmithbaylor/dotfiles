#!/usr/bin/env bash

set -e

function confirm() {
  # call with a prompt string or use a default
  read -r -p "${1:-Are you sure? [y/N]} " response
  case $response in
    [yY][eE][sS]|[yY])
      true
      ;;
    *)
      false
      ;;
  esac
}

symlinks=$(find * -maxdepth 1 -mindepth 1 ! -name '*.swp' |
                 grep -ve '^bin.*' |
                 grep -ve '^packages.*')

for link in $symlinks; do
    actual=$PWD/$link

    if [[ -f $link && $(head -n 1 $link | grep location) ]]; then
        symlink_path="$(head -n 1 $link | awk '{print $NF}' | sed "s|~|$HOME|")"
    else
        symlink_path="$HOME/.$(basename $link)"
    fi

    if [[ -e $symlink_path ]]; then
      exists=" (exists already)"
    else
      exists=""
    fi

    if confirm "Link $symlink_path -> $actual$exists? [y/N]"; then
      rm $symlink_path 2> /dev/null
      ln -sf $actual $symlink_path
    fi
done

if confirm "Create vim swapfiles/backup directories? [y/N]"; then
  mkdir -p $HOME/.vim/swapfiles
  mkdir -p $HOME/.vim/backup
fi

if confirm "Symlink neovim config? [y/N]"; then
  mkdir -p ~/.config
  ln -sf ~/.vim ~/.config/nvim
  ln -sf ~/.vimrc ~/.config/nvim/init.vim
fi

if confirm "Symlink personal binaries? [y/N]"; then
  rm -f $HOME/bin
  ln -sf $PWD/bin $HOME/bin
fi

unset confirm
unset symlinks
unset actual
unset symlink_path
unset exists
